<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MFL Friendly Match Analyzer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #334155 0%, #475569 50%, #334155 100%);
      background-attachment: fixed;
      color: #f1f5f9;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(255,255,255,0.02) 1px, transparent 1px),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 50px 50px, 80px 80px;
      pointer-events: none;
      z-index: 1;
      opacity: 0.6;
    }

    .header, .controls, .status-container, .overview-section, .matches-section, .footer {
      position: relative;
      z-index: 2;
      transform: translateZ(0);
    }

    .header {
      max-width: 1800px;
      margin: 0 auto 30px;
      text-align: center;
      padding: 30px 20px;
      background: rgba(30, 41, 59, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(238, 255, 0, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .header h1 {
      font-size: 42px;
      font-weight: 800;
      background: linear-gradient(135deg, #EEFF00 0%, #FFF76B 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .header p {
      color: #cbd5e1;
      font-size: 16px;
      font-weight: 400;
    }

    .controls {
      max-width: 1800px;
      margin: 0 auto 20px;
      background: rgba(30, 41, 59, 0.85);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .control-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 200px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #cbd5e1;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      padding: 14px 18px;
      font-size: 15px;
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      color: #f1f5f9;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #EEFF00;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 0 0 3px rgba(238, 255, 0, 0.15);
    }

    .form-input::placeholder {
      color: #94a3b8;
    }

    .btn {
      padding: 14px 26px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-family: inherit;
      letter-spacing: 0.3px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #EEFF00 0%, #FFF76B 100%);
      color: #1e293b;
      box-shadow: 0 4px 14px rgba(238, 255, 0, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(238, 255, 0, 0.4);
    }

    .btn-secondary {
      background: rgba(71, 85, 105, 0.8);
      color: #f1f5f9;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(100, 116, 139, 0.9);
      border-color: #EEFF00;
    }

    .btn-danger {
      background: rgba(220, 38, 38, 0.8);
      color: #fff;
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.9);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .add-match-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .status-container {
      max-width: 1800px;
      margin: 0 auto 20px;
      background: rgba(30, 41, 59, 0.85);
      padding: 14px 24px;
      border-radius: 12px;
      text-align: center;
      min-height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .status-text {
      font-size: 14px;
      color: #cbd5e1;
      font-weight: 500;
    }

    .status-text.loading {
      color: #EEFF00;
      font-weight: 600;
    }

    .status-text.success {
      color: #4ade80;
      font-weight: 600;
    }

    .status-text.error {
      color: #ef4444;
      font-weight: 600;
    }

    .overview-section {
      max-width: 1800px;
      margin: 0 auto 20px;
      display: none;
    }

    .overview-section.visible {
      display: block;
    }

    .team-overview-wrapper {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .overview-card {
      background: rgba(30, 41, 59, 0.85);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      flex: 1;
      min-width: 400px;
      max-width: 600px;
    }

    .overview-title {
      font-size: 20px;
      font-weight: 700;
      color: #EEFF00;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .overview-subtitle {
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 20px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }

    .stat-item {
      background: rgba(15, 23, 42, 0.8);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .stat-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .player-detail-card {
      background: rgba(30, 41, 59, 0.85);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .player-table-wrapper {
      overflow-x: auto;
      margin-top: 16px;
    }

    .player-detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
      font-size: 12px;
      white-space: nowrap;
    }

    .player-detail-table th {
      text-align: center;
      padding: 10px 8px;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 10px;
      border-bottom: 2px solid rgba(148, 163, 184, 0.2);
      cursor: pointer;
      user-select: none;
    }

    .player-detail-table th:first-child {
      text-align: left;
      padding-left: 12px;
    }

    .player-detail-table th:hover {
      color: #EEFF00;
    }

    .player-detail-table tbody tr {
      background: rgba(51, 65, 85, 0.7);
      transition: all 0.2s ease;
    }

    .player-detail-table tbody tr:hover {
      background: rgba(71, 85, 105, 0.9);
    }

    .player-detail-table td {
      padding: 12px 8px;
      text-align: center;
      color: #e2e8f0;
    }

    .player-detail-table td:first-child {
      text-align: left;
      padding-left: 12px;
      font-weight: 600;
      color: #f1f5f9;
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .player-detail-table td:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .sort-indicator {
      display: inline-block;
      margin-left: 4px;
      width: 8px;
      color: #EEFF00;
    }

    .matches-section {
      max-width: 1800px;
      margin: 0 auto 30px;
      display: none;
    }

    .matches-section.visible {
      display: block;
    }

    .matches-header {
      background: rgba(30, 41, 59, 0.85);
      padding: 20px 24px;
      border-radius: 16px 16px 0 0;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-bottom: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .matches-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: #EEFF00;
    }

    .matches-container {
      background: rgba(30, 41, 59, 0.85);
      padding: 0 24px 24px;
      border-radius: 0 0 16px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-top: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .match-item {
      background: rgba(51, 65, 85, 0.7);
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .match-item:hover {
      border-color: #EEFF00;
    }

    .match-main {
      padding: 16px 20px;
    }

    .match-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }

    .match-title-section {
      flex: 1;
    }

    .match-teams-title {
      font-size: 18px;
      font-weight: 700;
      color: #EEFF00;
      margin-bottom: 4px;
    }

    .match-meta {
      font-size: 12px;
      color: #94a3b8;
    }

    .match-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .match-toggle {
      font-size: 20px;
      color: #EEFF00;
      transition: transform 0.3s ease;
      cursor: pointer;
      padding: 4px 8px;
      user-select: none;
    }

    .match-item.expanded .match-toggle {
      transform: rotate(180deg);
    }

    .match-score-big {
      font-size: 32px;
      font-weight: 800;
      color: #EEFF00;
      text-align: center;
      margin-bottom: 12px;
    }

    .match-quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .quick-stat-card {
      background: rgba(30, 41, 59, 0.8);
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .quick-stat-label {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .quick-stat-values {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .quick-stat-home {
      color: #EEFF00;
    }

    .quick-stat-separator {
      color: #64748b;
      font-weight: 400;
      font-size: 14px;
    }

    .quick-stat-away {
      color: #94a3b8;
    }

    .match-details {
      display: none;
      padding: 20px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.4);
    }

    .match-item.expanded .match-details {
      display: block;
    }

    .full-stats-title {
      font-size: 18px;
      font-weight: 700;
      color: #EEFF00;
      margin-bottom: 16px;
      text-align: center;
    }

    .full-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .team-full-stats {
      background: rgba(30, 41, 59, 0.8);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .team-full-stats h4 {
      color: #EEFF00;
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      font-size: 13px;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-row .label {
      color: #94a3b8;
    }

    .stat-row .value {
      color: #f1f5f9;
      font-weight: 600;
    }

    .players-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #EEFF00;
      margin-bottom: 16px;
      text-align: center;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
    }

    .team-players-card {
      background: rgba(30, 41, 59, 0.8);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .team-players-card h5 {
      color: #EEFF00;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .players-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 4px;
      font-size: 11px;
    }

    .players-table th {
      text-align: center;
      padding: 8px 4px;
      color: #94a3b8;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 9px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .players-table th:first-child {
      text-align: left;
      padding-left: 8px;
    }

    .players-table tbody tr {
      background: rgba(51, 65, 85, 0.5);
      transition: all 0.2s ease;
    }

    .players-table tbody tr:hover {
      background: rgba(71, 85, 105, 0.7);
    }

    .players-table td {
      padding: 8px 4px;
      text-align: center;
      color: #e2e8f0;
    }

    .players-table td:first-child {
      text-align: left;
      padding-left: 8px;
      font-weight: 600;
      color: #f1f5f9;
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
    }

    .players-table td:last-child {
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    .footer {
      max-width: 1800px;
      margin: 40px auto 0;
      padding: 20px;
      text-align: center;
      color: #94a3b8;
      font-size: 13px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .footer-link {
      color: #EEFF00;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .footer-link:hover {
      color: #FFF76B;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 5px;
      transition: background 0.2s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #EEFF00;
    }

    @media (max-width: 1200px) {
      .team-overview-wrapper {
        flex-direction: column;
        align-items: center;
      }

      .overview-card {
        max-width: 100%;
      }

      .players-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 32px;
      }

      .control-row {
        flex-direction: column;
      }

      .form-group {
        width: 100%;
      }

      .stat-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .match-quick-stats {
        grid-template-columns: 1fr;
      }

      .full-stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚öΩ MFL Friendly Match Analyzer</h1>
    <p>Comprehensive team and player performance analysis across friendly matches</p>
  </div>

  <div class="controls">
    <div class="control-row">
      <div class="form-group">
        <label class="form-label">Club ID</label>
        <input 
          type="text" 
          id="club-id" 
          class="form-input" 
          placeholder="Enter club ID (e.g., 4036)..."
        />
      </div>

      <div class="form-group">
        <label class="form-label">Number of Games (Max 200)</label>
        <input 
          type="number" 
          id="game-limit" 
          class="form-input" 
          placeholder="50"
          min="1"
          max="200"
          value="50"
        />
      </div>

      <button id="load-btn" class="btn btn-primary">Load Matches</button>
    </div>

    <div class="add-match-section">
      <div class="control-row">
        <div class="form-group">
          <label class="form-label">Add Match by ID</label>
          <input 
            type="text" 
            id="match-id-input" 
            class="form-input" 
            placeholder="Enter match ID..."
          />
        </div>

        <button id="add-match-btn" class="btn btn-secondary">Add Match</button>
      </div>
    </div>
  </div>

  <div id="status-container" class="status-container">
    <div id="status" class="status-text">Enter a club ID to start analyzing friendly matches</div>
  </div>

  <div id="overview-section" class="overview-section">
    <div class="team-overview-wrapper">
      <div class="overview-card">
        <div class="overview-title">
          üè† Home Team Performance
        </div>
        <div class="overview-subtitle" id="home-overview-subtitle">Averages across all matches</div>
        <div id="home-stats" class="stat-grid"></div>
      </div>

      <div class="overview-card">
        <div class="overview-title">
          ‚úàÔ∏è Average Opponent
        </div>
        <div class="overview-subtitle" id="away-overview-subtitle">Away team averages</div>
        <div id="away-stats" class="stat-grid"></div>
      </div>
    </div>

    <div class="player-detail-card">
      <div class="overview-title">
        üë• Player Performance Detail
      </div>
      <div class="overview-subtitle" id="player-detail-subtitle">Individual stats for all home players</div>
      <div class="player-table-wrapper">
        <table id="player-detail-table" class="player-detail-table">
          <thead>
            <tr>
              <th data-col="name">Player</th>
              <th data-col="positions">Pos</th>
              <th data-col="apps">Apps</th>
              <th data-col="rating">Rating</th>
              <th data-col="goals">Goals</th>
              <th data-col="assists">Assists</th>
              <th data-col="xg">xG</th>
              <th data-col="xgPerShot">xG/Shot</th>
              <th data-col="shots">Shots</th>
              <th data-col="sot">SoT</th>
              <th data-col="shotAcc">Shot%</th>
              <th data-col="chancesCreated">Chances</th>
              <th data-col="passes">Passes</th>
              <th data-col="passAcc">Pass%</th>
              <th data-col="crosses">Crosses</th>
              <th data-col="crossAcc">Cross%</th>
              <th data-col="dribbles">Dribbles</th>
              <th data-col="dribbleRate">Drb%</th>
              <th data-col="dribbledPast">Drb Past</th>
              <th data-col="defDuels">Def Duels%</th>
              <th data-col="clearances">Clear</th>
              <th data-col="blocks">Blocks</th>
              <th data-col="possValue">Poss Val</th>
              <th data-col="fouls">Fouls</th>
              <th data-col="yc">YC</th>
              <th data-col="rc">RC</th>
              <th data-col="ownGoals">OG</th>
              <th data-col="shotsIntercepted">Sh Int</th>
              <th data-col="saves">Saves</th>
              <th data-col="goalsConceded">GC</th>
            </tr>
          </thead>
          <tbody id="player-detail-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="matches-section" class="matches-section">
    <div class="matches-header">
      <h2 id="matches-title">Match History</h2>
      <button id="download-csv-btn" class="btn btn-secondary">üì• Download CSV</button>
    </div>
    <div class="matches-container" id="matches-container"></div>
  </div>

  <div class="footer">
    <p>Built for the MFL community | 
      <a href="https://discord.com/users/ricky_hyde" target="_blank" class="footer-link">
        Suggestions? Contact ricky_hyde on Discord
      </a>
    </p>
  </div>

  <script>
    const API_BASE = 'https://z519wdyajg.execute-api.us-east-1.amazonaws.com/prod';
    let allMatches = [];
    let clubId = null;
    let squadId = null;
    let playerDetailSort = { column: 'rating', asc: false };
    let playerNamesCache = {};

    const POSITION_ORDER = ['GK', 'RB', 'RWB', 'CB', 'LB', 'LWB', 'CDM', 'RM', 'CM', 'LM', 'CAM', 'RW', 'CF', 'LW', 'ST'];

    function setStatus(msg, type = '') {
      const el = document.getElementById('status');
      if (el) {
        el.textContent = msg;
        el.className = 'status-text ' + type;
      }
    }

    async function fetchSquadIdFromClubId(clubId) {
      const url = `${API_BASE}/clubs/${clubId}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch club ${clubId}: ${response.status}`);

      const text = await response.text();
      const pattern = ':[{"id":';
      const index = text.indexOf(pattern);

      if (index === -1) throw new Error('Squad ID not found in club data');

      const afterPattern = text.substring(index + pattern.length);
      const match = afterPattern.match(/^(\d+)/);

      if (!match) throw new Error('Could not parse squad ID');
      return match[1];
    }

    async function fetchMatchIds(squadId, limit) {
      const url = `${API_BASE}/matches?squadId=${squadId}&past=true&limit=${limit}&onlyFriendliesHome=true`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch matches: ${response.status}`);
      return await response.json();
    }

    async function fetchMatchReport(matchId) {
      const url = `${API_BASE}/matches/${matchId}/report`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch match ${matchId}: ${response.status}`);
      return await response.json();
    }

    async function fetchMatchFormations(matchId) {
      const url = `${API_BASE}/matches/${matchId}?withFormations=true`;
      try {
        const response = await fetch(url);
        if (!response.ok) return null;
        return await response.json();
      } catch (e) {
        console.warn(`Failed to fetch formations for match ${matchId}:`, e);
        return null;
      }
    }

    function extractPlayerNamesFromFormations(formationsData) {
      const playerMap = {};

      if (!formationsData) return playerMap;

      const scanFormation = (formation) => {
        if (!formation || !Array.isArray(formation.positions)) return;

        formation.positions.forEach(pos => {
          const p = pos?.player;
          if (!p || !p.id) return;

          const id = String(p.id);
          const firstName = p.firstName || p.metadata?.firstName || '';
          const lastName = p.lastName || p.metadata?.lastName || '';
          const fullName = `${firstName} ${lastName}`.trim();

          if (fullName) {
            playerMap[id] = fullName;
          }
        });
      };

      scanFormation(formationsData.homeFormation);
      scanFormation(formationsData.awayFormation);

      return playerMap;
    }

    function computeXIOverall(formation, playerMap) {
      if (!formation || !Array.isArray(formation.positions)) return 0;

      const players = formation.positions
        .map(pos => pos?.player)
        .filter(p => p && p.id);

      if (players.length === 0) return 0;

      const ratings = players.map(p => {
        const id = String(p.id);
        const meta = playerMap[id];
        if (meta && typeof meta.matchOverall === 'number') {
          return meta.matchOverall;
        }
        return p.overall || p.metadata?.overallAtKickoff || p.metadata?.overall || 0;
      });

      const sum = ratings.reduce((acc, r) => acc + r, 0);
      return sum;
    }

    function extractPlayerMapFromFormations(formationsJson) {
      if (!formationsJson) return {};

      const playerMap = {};

      const scanFormation = (formation) => {
        if (!formation || !Array.isArray(formation.positions)) return;

        formation.positions.forEach(pos => {
          const p = pos?.player;
          if (!p || !p.id) return;

          const id = String(p.id);
          const firstName = p.firstName || p.metadata?.firstName || '';
          const lastName = p.lastName || p.metadata?.lastName || '';
          const name = `${firstName} ${lastName}`.trim() || `Player ${id}`;
          const positions = p.positions || p.metadata?.positions || [];
          const overall = p.overall || p.metadata?.overallAtKickoff || p.metadata?.overall || 0;

          playerMap[id] = {
            name,
            positions: Array.isArray(positions) ? positions : [],
            matchOverall: overall
          };
        });
      };

      scanFormation(formationsJson.homeFormation);
      scanFormation(formationsJson.awayFormation);

      return playerMap;
    }

    function extractClubNames(formationsData) {
      let homeName = 'Home Team';
      let awayName = 'Away Team';

      if (formationsData) {
        if (formationsData.home?.name) {
          homeName = formationsData.home.name;
        }
        if (formationsData.away?.name) {
          awayName = formationsData.away.name;
        }
      }

      return { homeName, awayName };
    }

    async function loadMatches() {
      const clubIdInput = document.getElementById('club-id').value.trim();
      const limitInput = document.getElementById('game-limit').value;

      if (!clubIdInput) {
        setStatus('Please enter a club ID', 'error');
        return;
      }

      clubId = clubIdInput;
      const limit = Math.min(Math.max(1, parseInt(limitInput) || 50), 200);

      setStatus(`Looking up squad ID for club ${clubId}...`, 'loading');

      try {
        squadId = await fetchSquadIdFromClubId(clubId);
        console.log(`[Club ${clubId}] Found squad ID: ${squadId}`);

        setStatus(`Found squad ${squadId}! Loading match IDs...`, 'loading');

        const matchesData = await fetchMatchIds(squadId, limit);

        if (!matchesData || matchesData.length === 0) {
          setStatus('No friendly matches found for this squad', 'error');
          return;
        }

        setStatus(`Loading ${matchesData.length} match reports and formations...`, 'loading');

        const matchReports = [];
        playerNamesCache = {};

        for (let i = 0; i < matchesData.length; i++) {
          try {
            const matchId = matchesData[i].id;
            const report = await fetchMatchReport(matchId);
            const formations = await fetchMatchFormations(matchId);

            if (formations) {
              const names = extractPlayerNamesFromFormations(formations);
              Object.assign(playerNamesCache, names);
            }

            matchReports.push({
              matchId: matchId,
              date: matchesData[i].startDate || new Date().toISOString(),
              report: report,
              formations: formations
            });

            if ((i + 1) % 10 === 0 || i === matchesData.length - 1) {
              setStatus(`Loaded ${i + 1}/${matchesData.length} matches...`, 'loading');
            }
          } catch (e) {
            console.error(`Failed to load match ${matchesData[i].id}:`, e);
          }
        }

        allMatches = matchReports;
        renderAll();
        setStatus(`Successfully loaded ${allMatches.length} matches!`, 'success');

      } catch (e) {
        console.error('Error loading matches:', e);
        setStatus(`Error: ${e.message}`, 'error');
      }
    }

    async function addMatch() {
      const matchIdInput = document.getElementById('match-id-input').value.trim();

      if (!matchIdInput) {
        setStatus('Please enter a match ID', 'error');
        return;
      }

      if (allMatches.find(m => m.matchId === matchIdInput)) {
        setStatus('Match already in list', 'error');
        return;
      }

      setStatus(`Loading match ${matchIdInput}...`, 'loading');

      try {
        const report = await fetchMatchReport(matchIdInput);
        const formations = await fetchMatchFormations(matchIdInput);

        if (formations) {
          const names = extractPlayerNamesFromFormations(formations);
          Object.assign(playerNamesCache, names);
        }

        allMatches.push({
          matchId: matchIdInput,
          date: new Date().toISOString(),
          report: report,
          formations: formations
        });

        document.getElementById('match-id-input').value = '';
        renderAll();
        setStatus(`Successfully added match ${matchIdInput}!`, 'success');

      } catch (e) {
        console.error('Error adding match:', e);
        setStatus(`Error: ${e.message}`, 'error');
      }
    }

    function deleteMatch(matchId) {
      if (!confirm(`Are you sure you want to delete match ${matchId}?`)) {
        return;
      }

      allMatches = allMatches.filter(m => m.matchId !== matchId);
      renderAll();
      setStatus(`Deleted match ${matchId}`, 'success');
    }

    function calculateTeamStats() {
      if (allMatches.length === 0) return null;

      const homeStats = {
        matches: allMatches.length,
        goals: 0,
        xG: 0,
        shots: 0,
        shotsOnTarget: 0,
        possession: 0,
        passes: 0,
        passAccuracy: 0,
        crosses: 0,
        crossAccuracy: 0,
        fouls: 0,
        yellowCards: 0,
        redCards: 0,
        defensiveDuelsWon: 0,
        dribbledPast: 0,
        shotsBlocked: 0,
        ownGoals: 0,
        cleanSheets: 0
      };

      const awayStats = {
        matches: allMatches.length,
        goals: 0,
        xG: 0,
        shots: 0,
        shotsOnTarget: 0,
        possession: 0,
        passes: 0,
        passAccuracy: 0,
        crosses: 0,
        crossAccuracy: 0,
        fouls: 0,
        yellowCards: 0,
        redCards: 0,
        defensiveDuelsWon: 0,
        dribbledPast: 0,
        shotsBlocked: 0,
        ownGoals: 0,
        cleanSheets: 0
      };

      let homeTotalPasses = 0;
      let homeAccuratePasses = 0;
      let homeTotalCrosses = 0;
      let homeAccurateCrosses = 0;

      let awayTotalPasses = 0;
      let awayAccuratePasses = 0;
      let awayTotalCrosses = 0;
      let awayAccurateCrosses = 0;

      allMatches.forEach(match => {
        const home = match.report?.home;
        const away = match.report?.away;

        if (home && home.playersStats) {
          let homeGoalsConceded = 0;

          home.playersStats.forEach(player => {
            homeStats.goals += player.goals || 0;
            homeStats.xG += player.xG || 0;
            homeStats.shots += player.shots || 0;
            homeStats.shotsOnTarget += player.shotsOnTarget || 0;
            homeStats.fouls += player.foulsCommitted || 0;
            homeStats.yellowCards += player.yellowCards || 0;
            homeStats.redCards += player.redCards || 0;
            homeStats.defensiveDuelsWon += player.defensiveDuelsWon || 0;
            homeStats.dribbledPast += player.dribbledPast || 0;
            homeStats.shotsBlocked += player.shotsInterceptions || 0;
            homeStats.ownGoals += player.ownGoals || 0;
            homeGoalsConceded += player.goalsConceded || 0;

            if (player.passes) {
              homeTotalPasses += player.passes;
              homeAccuratePasses += player.passesAccurate || 0;
            }

            if (player.crosses) {
              homeTotalCrosses += player.crosses;
              homeAccurateCrosses += player.crossesAccurate || 0;
            }
          });

          if (homeGoalsConceded === 0) {
            homeStats.cleanSheets++;
          }

          const homePasses = home.playersStats.reduce((sum, p) => sum + (p.passes || 0), 0);
          const awayPasses = away?.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
          const totalPassesMatch = homePasses + awayPasses;
          if (totalPassesMatch > 0) {
            homeStats.possession += (homePasses / totalPassesMatch) * 100;
          }
        }

        if (away && away.playersStats) {
          let awayGoalsConceded = 0;

          away.playersStats.forEach(player => {
            awayStats.goals += player.goals || 0;
            awayStats.xG += player.xG || 0;
            awayStats.shots += player.shots || 0;
            awayStats.shotsOnTarget += player.shotsOnTarget || 0;
            awayStats.fouls += player.foulsCommitted || 0;
            awayStats.yellowCards += player.yellowCards || 0;
            awayStats.redCards += player.redCards || 0;
            awayStats.defensiveDuelsWon += player.defensiveDuelsWon || 0;
            awayStats.dribbledPast += player.dribbledPast || 0;
            awayStats.shotsBlocked += player.shotsInterceptions || 0;
            awayStats.ownGoals += player.ownGoals || 0;
            awayGoalsConceded += player.goalsConceded || 0;

            if (player.passes) {
              awayTotalPasses += player.passes;
              awayAccuratePasses += player.passesAccurate || 0;
            }

            if (player.crosses) {
              awayTotalCrosses += player.crosses;
              awayAccurateCrosses += player.crossesAccurate || 0;
            }
          });

          if (awayGoalsConceded === 0) {
            awayStats.cleanSheets++;
          }

          const homePasses = home?.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
          const awayPasses = away.playersStats.reduce((sum, p) => sum + (p.passes || 0), 0);
          const totalPassesMatch = homePasses + awayPasses;
          if (totalPassesMatch > 0) {
            awayStats.possession += (awayPasses / totalPassesMatch) * 100;
          }
        }
      });

      const mc = allMatches.length;

      // Home averages
      homeStats.goals = (homeStats.goals / mc).toFixed(2);
      homeStats.xG = (homeStats.xG / mc).toFixed(2);
      homeStats.shots = (homeStats.shots / mc).toFixed(1);
      homeStats.shotsOnTarget = (homeStats.shotsOnTarget / mc).toFixed(1);
      homeStats.shotAccuracy = homeStats.shots > 0 ? ((homeStats.shotsOnTarget / homeStats.shots) * 100).toFixed(1) : '0';
      homeStats.possession = (homeStats.possession / mc).toFixed(1);
      homeStats.passes = (homeTotalPasses / mc).toFixed(0);
      homeStats.passAccuracy = homeTotalPasses > 0 ? ((homeAccuratePasses / homeTotalPasses) * 100).toFixed(1) : '0';
      homeStats.crosses = (homeTotalCrosses / mc).toFixed(1);
      homeStats.crossAccuracy = homeTotalCrosses > 0 ? ((homeAccurateCrosses / homeTotalCrosses) * 100).toFixed(1) : '0';
      homeStats.fouls = (homeStats.fouls / mc).toFixed(1);
      homeStats.yellowCards = (homeStats.yellowCards / mc).toFixed(1);
      homeStats.redCards = (homeStats.redCards / mc).toFixed(2);
      homeStats.defensiveDuelsWon = (homeStats.defensiveDuelsWon / mc).toFixed(1);
      homeStats.dribbledPast = (homeStats.dribbledPast / mc).toFixed(1);
      homeStats.totalDuels = ((homeStats.defensiveDuelsWon * mc + homeStats.dribbledPast * mc) / mc).toFixed(1);
      homeStats.defDuelWinRate = (homeStats.defensiveDuelsWon * mc + homeStats.dribbledPast * mc) > 0 
        ? ((homeStats.defensiveDuelsWon * mc / (homeStats.defensiveDuelsWon * mc + homeStats.dribbledPast * mc)) * 100).toFixed(1) 
        : '0';
      homeStats.shotsBlocked = (homeStats.shotsBlocked / mc).toFixed(1);
      homeStats.ownGoals = (homeStats.ownGoals / mc).toFixed(2);

      // Away averages
      awayStats.goals = (awayStats.goals / mc).toFixed(2);
      awayStats.xG = (awayStats.xG / mc).toFixed(2);
      awayStats.shots = (awayStats.shots / mc).toFixed(1);
      awayStats.shotsOnTarget = (awayStats.shotsOnTarget / mc).toFixed(1);
      awayStats.shotAccuracy = awayStats.shots > 0 ? ((awayStats.shotsOnTarget / awayStats.shots) * 100).toFixed(1) : '0';
      awayStats.possession = (awayStats.possession / mc).toFixed(1);
      awayStats.passes = (awayTotalPasses / mc).toFixed(0);
      awayStats.passAccuracy = awayTotalPasses > 0 ? ((awayAccuratePasses / awayTotalPasses) * 100).toFixed(1) : '0';
      awayStats.crosses = (awayTotalCrosses / mc).toFixed(1);
      awayStats.crossAccuracy = awayTotalCrosses > 0 ? ((awayAccurateCrosses / awayTotalCrosses) * 100).toFixed(1) : '0';
      awayStats.fouls = (awayStats.fouls / mc).toFixed(1);
      awayStats.yellowCards = (awayStats.yellowCards / mc).toFixed(1);
      awayStats.redCards = (awayStats.redCards / mc).toFixed(2);
      awayStats.defensiveDuelsWon = (awayStats.defensiveDuelsWon / mc).toFixed(1);
      awayStats.dribbledPast = (awayStats.dribbledPast / mc).toFixed(1);
      awayStats.totalDuels = ((awayStats.defensiveDuelsWon * mc + awayStats.dribbledPast * mc) / mc).toFixed(1);
      awayStats.defDuelWinRate = (awayStats.defensiveDuelsWon * mc + awayStats.dribbledPast * mc) > 0 
        ? ((awayStats.defensiveDuelsWon * mc / (awayStats.defensiveDuelsWon * mc + awayStats.dribbledPast * mc)) * 100).toFixed(1) 
        : '0';
      awayStats.shotsBlocked = (awayStats.shotsBlocked / mc).toFixed(1);
      awayStats.ownGoals = (awayStats.ownGoals / mc).toFixed(2);

      return { home: homeStats, away: awayStats };
    }

    function calculatePlayerStats() {
      if (allMatches.length === 0) return null;

      const playerAggregates = {};

      allMatches.forEach(match => {
        const home = match.report?.home;
        if (!home || !home.playersStats) return;

        home.playersStats.forEach(player => {
          const pid = String(player.playerId);

          if (!playerAggregates[pid]) {
            const cachedName = playerNamesCache[pid];
            const playerName = cachedName || `Player ${pid}`;

            playerAggregates[pid] = {
              playerId: pid,
              playerName: playerName,
              appearances: 0,
              goals: 0,
              assists: 0,
              xG: 0,
              shots: 0,
              shotsOnTarget: 0,
              chancesCreated: 0,
              passes: 0,
              passesAccurate: 0,
              crosses: 0,
              crossesAccurate: 0,
              dribblingSuccess: 0,
              dribbledPast: 0,
              defensiveDuelsWon: 0,
              defensiveDuelsTotal: 0,
              clearances: 0,
              shotsInterceptions: 0,
              shotsIntercepted: 0,
              fouls: 0,
              yellowCards: 0,
              redCards: 0,
              ownGoals: 0,
              saves: 0,
              goalsConceded: 0,
              ratingSum: 0,
              positions: new Set()
            };
          }

          const agg = playerAggregates[pid];
          agg.appearances++;
          agg.goals += player.goals || 0;
          agg.assists += player.assists || 0;
          agg.xG += player.xG || 0;
          agg.shots += player.shots || 0;
          agg.shotsOnTarget += player.shotsOnTarget || 0;
          agg.chancesCreated += player.chancesCreated || 0;
          agg.passes += player.passes || 0;
          agg.passesAccurate += player.passesAccurate || 0;
          agg.crosses += player.crosses || 0;
          agg.crossesAccurate += player.crossesAccurate || 0;
          agg.dribblingSuccess += player.dribblingSuccess || 0;
          agg.dribbledPast += player.dribbledPast || 0;
          agg.defensiveDuelsWon += player.defensiveDuelsWon || 0;
          agg.defensiveDuelsTotal += (player.defensiveDuelsWon || 0) + (player.dribbledPast || 0);
          agg.clearances += player.clearances || 0;
          agg.shotsInterceptions += player.shotsInterceptions || 0;
          agg.shotsIntercepted += player.shotsIntercepted || 0;
          agg.fouls += player.foulsCommitted || 0;
          agg.yellowCards += player.yellowCards || 0;
          agg.redCards += player.redCards || 0;
          agg.ownGoals += player.ownGoals || 0;
          agg.saves += player.saves || 0;
          agg.goalsConceded += player.goalsConceded || 0;
          agg.ratingSum += player.rating || 0;

          if (player.position) {
            agg.positions.add(player.position);
          }
        });
      });

      return playerAggregates;
    }

    function getPositionSortValue(positions) {
      if (positions.size === 0) return 999;

      let minIndex = 999;
      positions.forEach(pos => {
        const index = POSITION_ORDER.indexOf(pos);
        if (index !== -1 && index < minIndex) {
          minIndex = index;
        }
      });

      return minIndex;
    }

    function renderHomeOverview() {
      const stats = calculateTeamStats();
      if (!stats) return;

      const container = document.getElementById('home-stats');
      document.getElementById('home-overview-subtitle').textContent = `Averages across ${stats.home.matches} matches`;

      container.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">Goals</div>
          <div class="stat-value">${stats.home.goals}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">xG</div>
          <div class="stat-value">${stats.home.xG}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots</div>
          <div class="stat-value">${stats.home.shots}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots on Target</div>
          <div class="stat-value">${stats.home.shotsOnTarget}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shot Accuracy</div>
          <div class="stat-value">${stats.home.shotAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Possession</div>
          <div class="stat-value">${stats.home.possession}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Passes</div>
          <div class="stat-value">${stats.home.passes}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Pass Accuracy</div>
          <div class="stat-value">${stats.home.passAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Crosses</div>
          <div class="stat-value">${stats.home.crosses}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Cross Accuracy</div>
          <div class="stat-value">${stats.home.crossAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Def Duel Win %</div>
          <div class="stat-value">${stats.home.defDuelWinRate}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total Duels</div>
          <div class="stat-value">${stats.home.totalDuels}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots Blocked</div>
          <div class="stat-value">${stats.home.shotsBlocked}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Clean Sheets</div>
          <div class="stat-value">${stats.home.cleanSheets}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Own Goals</div>
          <div class="stat-value">${stats.home.ownGoals}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Fouls</div>
          <div class="stat-value">${stats.home.fouls}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Yellow Cards</div>
          <div class="stat-value">${stats.home.yellowCards}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Red Cards</div>
          <div class="stat-value">${stats.home.redCards}</div>
        </div>
      `;
    }

    function renderAwayOverview() {
      const stats = calculateTeamStats();
      if (!stats) return;

      const container = document.getElementById('away-stats');
      document.getElementById('away-overview-subtitle').textContent = `Opponent averages across ${stats.away.matches} matches`;

      container.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">Goals</div>
          <div class="stat-value">${stats.away.goals}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">xG</div>
          <div class="stat-value">${stats.away.xG}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots</div>
          <div class="stat-value">${stats.away.shots}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots on Target</div>
          <div class="stat-value">${stats.away.shotsOnTarget}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shot Accuracy</div>
          <div class="stat-value">${stats.away.shotAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Possession</div>
          <div class="stat-value">${stats.away.possession}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Passes</div>
          <div class="stat-value">${stats.away.passes}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Pass Accuracy</div>
          <div class="stat-value">${stats.away.passAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Crosses</div>
          <div class="stat-value">${stats.away.crosses}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Cross Accuracy</div>
          <div class="stat-value">${stats.away.crossAccuracy}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Def Duel Win %</div>
          <div class="stat-value">${stats.away.defDuelWinRate}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total Duels</div>
          <div class="stat-value">${stats.away.totalDuels}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Shots Blocked</div>
          <div class="stat-value">${stats.away.shotsBlocked}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Clean Sheets</div>
          <div class="stat-value">${stats.away.cleanSheets}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Own Goals</div>
          <div class="stat-value">${stats.away.ownGoals}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Fouls</div>
          <div class="stat-value">${stats.away.fouls}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Yellow Cards</div>
          <div class="stat-value">${stats.away.yellowCards}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Red Cards</div>
          <div class="stat-value">${stats.away.redCards}</div>
        </div>
      `;
    }

    function sortPlayers(playerAggregates) {
      const players = Object.values(playerAggregates);
      const col = playerDetailSort.column;
      const asc = playerDetailSort.asc;

      players.sort((a, b) => {
        let valA, valB;

        switch (col) {
          case 'name':
            valA = a.playerName;
            valB = b.playerName;
            break;
          case 'positions':
            valA = getPositionSortValue(a.positions);
            valB = getPositionSortValue(b.positions);
            break;
          case 'apps':
            valA = a.appearances;
            valB = b.appearances;
            break;
          case 'rating':
            valA = a.ratingSum / a.appearances;
            valB = b.ratingSum / b.appearances;
            break;
          case 'goals':
            valA = a.goals;
            valB = b.goals;
            break;
          case 'assists':
            valA = a.assists;
            valB = b.assists;
            break;
          case 'xg':
            valA = a.xG;
            valB = b.xG;
            break;
          case 'xgPerShot':
            valA = a.shots > 0 ? (a.xG / a.shots) : 0;
            valB = b.shots > 0 ? (b.xG / b.shots) : 0;
            break;
          case 'shots':
            valA = a.shots;
            valB = b.shots;
            break;
          case 'sot':
            valA = a.shotsOnTarget;
            valB = b.shotsOnTarget;
            break;
          case 'shotAcc':
            valA = a.shots > 0 ? (a.shotsOnTarget / a.shots) : 0;
            valB = b.shots > 0 ? (b.shotsOnTarget / b.shots) : 0;
            break;
          case 'chancesCreated':
            valA = a.chancesCreated;
            valB = b.chancesCreated;
            break;
          case 'passes':
            valA = a.passes;
            valB = b.passes;
            break;
          case 'passAcc':
            valA = a.passes > 0 ? (a.passesAccurate / a.passes) : 0;
            valB = b.passes > 0 ? (b.passesAccurate / b.passes) : 0;
            break;
          case 'crosses':
            valA = a.crosses;
            valB = b.crosses;
            break;
          case 'crossAcc':
            valA = a.crosses > 0 ? (a.crossesAccurate / a.crosses) : 0;
            valB = b.crosses > 0 ? (b.crossesAccurate / b.crosses) : 0;
            break;
          case 'dribbles':
            valA = a.dribblingSuccess;
            valB = b.dribblingSuccess;
            break;
          case 'dribbleRate':
            valA = (a.dribblingSuccess + a.dribbledPast) > 0 ? (a.dribblingSuccess / (a.dribblingSuccess + a.dribbledPast)) : 0;
            valB = (b.dribblingSuccess + b.dribbledPast) > 0 ? (b.dribblingSuccess / (b.dribblingSuccess + b.dribbledPast)) : 0;
            break;
          case 'dribbledPast':
            valA = a.dribbledPast;
            valB = b.dribbledPast;
            break;
          case 'defDuels':
            valA = a.defensiveDuelsTotal > 0 ? (a.defensiveDuelsWon / a.defensiveDuelsTotal) : 0;
            valB = b.defensiveDuelsTotal > 0 ? (b.defensiveDuelsWon / b.defensiveDuelsTotal) : 0;
            break;
          case 'clearances':
            valA = a.clearances;
            valB = b.clearances;
            break;
          case 'blocks':
            valA = a.shotsInterceptions;
            valB = b.shotsInterceptions;
            break;
          case 'possValue':
            valA = (a.passes + a.dribblingSuccess) - (a.passes - a.passesAccurate);
            valB = (b.passes + b.dribblingSuccess) - (b.passes - b.passesAccurate);
            break;
          case 'fouls':
            valA = a.fouls;
            valB = b.fouls;
            break;
          case 'yc':
            valA = a.yellowCards;
            valB = b.yellowCards;
            break;
          case 'rc':
            valA = a.redCards;
            valB = b.redCards;
            break;
          case 'ownGoals':
            valA = a.ownGoals;
            valB = b.ownGoals;
            break;
          case 'shotsIntercepted':
            valA = a.shotsIntercepted;
            valB = b.shotsIntercepted;
            break;
          case 'saves':
            valA = a.saves;
            valB = b.saves;
            break;
          case 'goalsConceded':
            valA = a.goalsConceded;
            valB = b.goalsConceded;
            break;
          default:
            valA = a.ratingSum / a.appearances;
            valB = b.ratingSum / b.appearances;
        }

        if (typeof valA === 'string') {
          return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }

        return asc ? valA - valB : valB - valA;
      });

      return players;
    }

    function renderPlayerDetail() {
      const playerAggregates = calculatePlayerStats();
      if (!playerAggregates) return;

      const players = sortPlayers(playerAggregates);

      document.getElementById('player-detail-subtitle').textContent = `${players.length} unique players`;

      const tbody = document.getElementById('player-detail-body');
      tbody.innerHTML = '';

      document.querySelectorAll('#player-detail-table th').forEach(th => {
        const indicator = th.querySelector('.sort-indicator');
        if (indicator) indicator.remove();
      });

      const currentTh = document.querySelector(`#player-detail-table th[data-col="${playerDetailSort.column}"]`);
      if (currentTh) {
        const indicator = document.createElement('span');
        indicator.className = 'sort-indicator';
        indicator.textContent = playerDetailSort.asc ? '‚ñ≤' : '‚ñº';
        currentTh.appendChild(indicator);
      }

      players.forEach(player => {
        const avgRating = (player.ratingSum / player.appearances).toFixed(2);
        const xgPerShot = player.shots > 0 ? (player.xG / player.shots).toFixed(2) : '0.00';
        const shotAcc = player.shots > 0 ? ((player.shotsOnTarget / player.shots) * 100).toFixed(1) : '0';
        const passAcc = player.passes > 0 ? ((player.passesAccurate / player.passes) * 100).toFixed(1) : '0';
        const crossAcc = player.crosses > 0 ? ((player.crossesAccurate / player.crosses) * 100).toFixed(1) : '0';
        const dribbleRate = (player.dribblingSuccess + player.dribbledPast) > 0 
          ? ((player.dribblingSuccess / (player.dribblingSuccess + player.dribbledPast)) * 100).toFixed(1) 
          : '0';
        const defDuelsPct = player.defensiveDuelsTotal > 0 ? ((player.defensiveDuelsWon / player.defensiveDuelsTotal) * 100).toFixed(1) : '0';
        const possValue = (player.passes + player.dribblingSuccess) - (player.passes - player.passesAccurate);

        const positionsArray = Array.from(player.positions).sort((a, b) => {
          const indexA = POSITION_ORDER.indexOf(a);
          const indexB = POSITION_ORDER.indexOf(b);
          return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
        });
        const positions = positionsArray.length > 0 ? positionsArray.join(' / ') : '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${player.playerName}</td>
          <td>${positions}</td>
          <td>${player.appearances}</td>
          <td>${avgRating}</td>
          <td>${player.goals}</td>
          <td>${player.assists}</td>
          <td>${player.xG.toFixed(2)}</td>
          <td>${xgPerShot}</td>
          <td>${player.shots}</td>
          <td>${player.shotsOnTarget}</td>
          <td>${shotAcc}%</td>
          <td>${player.chancesCreated}</td>
          <td>${player.passes}</td>
          <td>${passAcc}%</td>
          <td>${player.crosses}</td>
          <td>${crossAcc}%</td>
          <td>${player.dribblingSuccess}</td>
          <td>${dribbleRate}%</td>
          <td>${player.dribbledPast}</td>
          <td>${defDuelsPct}%</td>
          <td>${player.clearances}</td>
          <td>${player.shotsInterceptions}</td>
          <td>${possValue}</td>
          <td>${player.fouls}</td>
          <td>${player.yellowCards}</td>
          <td>${player.redCards}</td>
          <td>${player.ownGoals}</td>
          <td>${player.shotsIntercepted}</td>
          <td>${player.saves}</td>
          <td>${player.goalsConceded}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMatches() {
      const container = document.getElementById('matches-container');

      if (allMatches.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; padding: 20px;">No matches loaded</p>';
        return;
      }

      document.getElementById('matches-title').textContent = `Match History (${allMatches.length} matches)`;

      container.innerHTML = '';

      allMatches.forEach(match => {
        const home = match.report?.home;
        const away = match.report?.away;
        const formations = match.formations;

        if (!home || !away) return;

        const homeGoals = home.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;
        const awayGoals = away.playersStats?.reduce((sum, p) => sum + (p.goals || 0), 0) || 0;

        const homeStats = aggregateTeamStats(home.playersStats);
        const awayStats = aggregateTeamStats(away.playersStats);

        let homeFormationType = '-';
        let awayFormationType = '-';
        let homeXIOverall = 0;
        let awayXIOverall = 0;
        let homeName = 'Home Team';
        let awayName = 'Away Team';

        if (formations) {
          const playerMap = extractPlayerMapFromFormations(formations);
          const clubNames = extractClubNames(formations);

          homeName = clubNames.homeName;
          awayName = clubNames.awayName;

          if (formations.homeFormation) {
            homeFormationType = formations.homeFormation.type || '-';
            homeXIOverall = computeXIOverall(formations.homeFormation, playerMap);
          }

          if (formations.awayFormation) {
            awayFormationType = formations.awayFormation.type || '-';
            awayXIOverall = computeXIOverall(formations.awayFormation, playerMap);
          }
        }

        const homePasses = home.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
        const awayPasses = away.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
        const totalPasses = homePasses + awayPasses;
        const homePossession = totalPasses > 0 ? ((homePasses / totalPasses) * 100).toFixed(1) : '50.0';
        const awayPossession = totalPasses > 0 ? ((awayPasses / totalPasses) * 100).toFixed(1) : '50.0';

        const matchDiv = document.createElement('div');
        matchDiv.className = 'match-item';

        const matchMain = document.createElement('div');
        matchMain.className = 'match-main';

        matchMain.innerHTML = `
          <div class="match-header-row">
            <div class="match-title-section">
              <div class="match-teams-title">${homeName} vs ${awayName}</div>
              <div class="match-meta">${new Date(match.date).toLocaleString()} | ID: ${match.matchId}</div>
            </div>
            <div class="match-actions">
              <button class="btn btn-danger" onclick="deleteMatch('${match.matchId}')">üóëÔ∏è Delete</button>
              <span class="match-toggle">‚ñº</span>
            </div>
          </div>

          <div class="match-score-big">${homeGoals} - ${awayGoals}</div>

          <div class="match-quick-stats">
            <div class="quick-stat-card">
              <div class="quick-stat-label">Formation</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homeFormationType}</span>
                <span class="quick-stat-separator">vs</span>
                <span class="quick-stat-away">${awayFormationType}</span>
              </div>
            </div>

            <div class="quick-stat-card">
              <div class="quick-stat-label">XI Overall</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homeXIOverall}</span>
                <span class="quick-stat-separator">vs</span>
                <span class="quick-stat-away">${awayXIOverall}</span>
              </div>
            </div>

            <div class="quick-stat-card">
              <div class="quick-stat-label">xG</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homeStats.xG.toFixed(2)}</span>
                <span class="quick-stat-separator">-</span>
                <span class="quick-stat-away">${awayStats.xG.toFixed(2)}</span>
              </div>
            </div>

            <div class="quick-stat-card">
              <div class="quick-stat-label">Shots</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homeStats.shots}</span>
                <span class="quick-stat-separator">-</span>
                <span class="quick-stat-away">${awayStats.shots}</span>
              </div>
            </div>

            <div class="quick-stat-card">
              <div class="quick-stat-label">Shots on Target</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homeStats.shotsOnTarget}</span>
                <span class="quick-stat-separator">-</span>
                <span class="quick-stat-away">${awayStats.shotsOnTarget}</span>
              </div>
            </div>

            <div class="quick-stat-card">
              <div class="quick-stat-label">Possession</div>
              <div class="quick-stat-values">
                <span class="quick-stat-home">${homePossession}%</span>
                <span class="quick-stat-separator">-</span>
                <span class="quick-stat-away">${awayPossession}%</span>
              </div>
            </div>
          </div>
        `;

        matchDiv.appendChild(matchMain);

        const matchDetails = document.createElement('div');
        matchDetails.className = 'match-details';
        matchDetails.innerHTML = `
          <div class="full-stats-title">üìä Complete Match Statistics</div>
          <div class="full-stats-grid">
            <div class="team-full-stats">
              <h4>üè† ${homeName}</h4>
              ${renderFullTeamStats(homeStats)}
            </div>
            <div class="team-full-stats">
              <h4>‚úàÔ∏è ${awayName}</h4>
              ${renderFullTeamStats(awayStats)}
            </div>
          </div>

          <div class="players-section-title">üë• Match Players & Performance</div>
          <div class="players-grid">
            <div class="team-players-card">
              <h5>üè† ${homeName} Players</h5>
              ${renderMatchPlayers(home.playersStats, playerNamesCache)}
            </div>
            <div class="team-players-card">
              <h5>‚úàÔ∏è ${awayName} Players</h5>
              ${renderMatchPlayers(away.playersStats, playerNamesCache)}
            </div>
          </div>
        `;

        matchDiv.appendChild(matchDetails);

        matchMain.querySelector('.match-toggle').addEventListener('click', (e) => {
          e.stopPropagation();
          matchDiv.classList.toggle('expanded');
        });

        container.appendChild(matchDiv);
      });
    }

    function renderFullTeamStats(stats) {
      if (!stats) return '<p>No stats available</p>';

      const passAcc = stats.passes > 0 ? ((stats.passesAccurate / stats.passes) * 100).toFixed(1) : '0';
      const crossAcc = stats.crosses > 0 ? ((stats.crossesAccurate / stats.crosses) * 100).toFixed(1) : '0';
      const shotAcc = stats.shots > 0 ? ((stats.shotsOnTarget / stats.shots) * 100).toFixed(1) : '0';
      const defDuelWinRate = (stats.defensiveDuelsWon + stats.dribbledPast) > 0 
        ? ((stats.defensiveDuelsWon / (stats.defensiveDuelsWon + stats.dribbledPast)) * 100).toFixed(1) 
        : '0';
      const totalDuels = stats.defensiveDuelsWon + stats.dribbledPast;

      return `
        <div class="stat-row"><span class="label">Goals</span><span class="value">${stats.goals}</span></div>
        <div class="stat-row"><span class="label">Assists</span><span class="value">${stats.assists}</span></div>
        <div class="stat-row"><span class="label">xG</span><span class="value">${stats.xG.toFixed(2)}</span></div>
        <div class="stat-row"><span class="label">Shots</span><span class="value">${stats.shots}</span></div>
        <div class="stat-row"><span class="label">Shots on Target</span><span class="value">${stats.shotsOnTarget}</span></div>
        <div class="stat-row"><span class="label">Shot Accuracy</span><span class="value">${shotAcc}%</span></div>
        <div class="stat-row"><span class="label">Passes</span><span class="value">${stats.passes}</span></div>
        <div class="stat-row"><span class="label">Pass Acc.</span><span class="value">${passAcc}%</span></div>
        <div class="stat-row"><span class="label">Crosses</span><span class="value">${stats.crosses}</span></div>
        <div class="stat-row"><span class="label">Cross Acc.</span><span class="value">${crossAcc}%</span></div>
        <div class="stat-row"><span class="label">Chances Created</span><span class="value">${stats.chancesCreated}</span></div>
        <div class="stat-row"><span class="label">Def Duel Win Rate</span><span class="value">${defDuelWinRate}%</span></div>
        <div class="stat-row"><span class="label">Total Duels</span><span class="value">${totalDuels}</span></div>
        <div class="stat-row"><span class="label">Shots Blocked</span><span class="value">${stats.shotsBlocked}</span></div>
        <div class="stat-row"><span class="label">Own Goals</span><span class="value">${stats.ownGoals}</span></div>
        <div class="stat-row"><span class="label">Fouls</span><span class="value">${stats.fouls}</span></div>
        <div class="stat-row"><span class="label">Yellow Cards</span><span class="value">${stats.yellowCards}</span></div>
        <div class="stat-row"><span class="label">Red Cards</span><span class="value">${stats.redCards}</span></div>
        <div class="stat-row"><span class="label">Avg Rating</span><span class="value">${stats.avgRating}</span></div>
      `;
    }

    function renderMatchPlayers(playersStats, namesCache) {
      if (!playersStats || playersStats.length === 0) {
        return '<p style="color: #94a3b8; padding: 10px;">No player data available</p>';
      }

      const sortedPlayers = [...playersStats].sort((a, b) => {
        const posA = POSITION_ORDER.indexOf(a.position);
        const posB = POSITION_ORDER.indexOf(b.position);
        return (posA === -1 ? 999 : posA) - (posB === -1 ? 999 : posB);
      });

      let html = `
        <table class="players-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Pos</th>
              <th>Rating</th>
              <th>G</th>
              <th>A</th>
              <th>xG</th>
              <th>Shots</th>
              <th>SoT</th>
              <th>Passes</th>
              <th>Pass%</th>
              <th>YC</th>
              <th>RC</th>
            </tr>
          </thead>
          <tbody>
      `;

      sortedPlayers.forEach(player => {
        const pid = String(player.playerId);
        const name = namesCache[pid] || `Player ${pid}`;
        const passAcc = player.passes > 0 ? ((player.passesAccurate / player.passes) * 100).toFixed(0) : '0';

        html += `
          <tr>
            <td>${name}</td>
            <td>${player.position || '-'}</td>
            <td>${(player.rating || 0).toFixed(1)}</td>
            <td>${player.goals || 0}</td>
            <td>${player.assists || 0}</td>
            <td>${(player.xG || 0).toFixed(1)}</td>
            <td>${player.shots || 0}</td>
            <td>${player.shotsOnTarget || 0}</td>
            <td>${player.passes || 0}</td>
            <td>${passAcc}%</td>
            <td>${player.yellowCards || 0}</td>
            <td>${player.redCards || 0}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      return html;
    }

    function aggregateTeamStats(playersStats) {
      if (!playersStats) return null;

      const stats = {
        goals: 0,
        assists: 0,
        xG: 0,
        shots: 0,
        shotsOnTarget: 0,
        passes: 0,
        passesAccurate: 0,
        crosses: 0,
        crossesAccurate: 0,
        chancesCreated: 0,
        fouls: 0,
        yellowCards: 0,
        redCards: 0,
        avgRating: 0,
        defensiveDuelsWon: 0,
        dribbledPast: 0,
        shotsBlocked: 0,
        ownGoals: 0
      };

      playersStats.forEach(player => {
        stats.goals += player.goals || 0;
        stats.assists += player.assists || 0;
        stats.xG += player.xG || 0;
        stats.shots += player.shots || 0;
        stats.shotsOnTarget += player.shotsOnTarget || 0;
        stats.passes += player.passes || 0;
        stats.passesAccurate += player.passesAccurate || 0;
        stats.crosses += player.crosses || 0;
        stats.crossesAccurate += player.crossesAccurate || 0;
        stats.chancesCreated += player.chancesCreated || 0;
        stats.fouls += player.foulsCommitted || 0;
        stats.yellowCards += player.yellowCards || 0;
        stats.redCards += player.redCards || 0;
        stats.avgRating += player.rating || 0;
        stats.defensiveDuelsWon += player.defensiveDuelsWon || 0;
        stats.dribbledPast += player.dribbledPast || 0;
        stats.shotsBlocked += player.shotsInterceptions || 0;
        stats.ownGoals += player.ownGoals || 0;
      });

      stats.avgRating = (stats.avgRating / playersStats.length).toFixed(2);

      return stats;
    }

    function renderAll() {
      if (allMatches.length > 0) {
        document.getElementById('overview-section').classList.add('visible');
        document.getElementById('matches-section').classList.add('visible');
        renderHomeOverview();
        renderAwayOverview();
        renderPlayerDetail();
        renderMatches();
      } else {
        document.getElementById('overview-section').classList.remove('visible');
        document.getElementById('matches-section').classList.remove('visible');
      }
    }

    function downloadCSV() {
      if (allMatches.length === 0) {
        alert('No data to export');
        return;
      }

      const rows = [];

      rows.push([
        'Match ID', 'Date', 'Home Team', 'Away Team', 'Score', 'Home Goals', 'Away Goals',
        'Home xG', 'Away xG', 'Home Shots', 'Away Shots',
        'Home SoT', 'Away SoT', 'Home Shot Acc%', 'Away Shot Acc%',
        'Home Possession%', 'Away Possession%',
        'Home Passes', 'Away Passes',
        'Home Pass Acc%', 'Away Pass Acc%', 
        'Home Def Duel Win%', 'Away Def Duel Win%',
        'Home Total Duels', 'Away Total Duels',
        'Home Shots Blocked', 'Away Shots Blocked',
        'Home Own Goals', 'Away Own Goals',
        'Home Fouls', 'Away Fouls',
        'Home YC', 'Away YC', 'Home RC', 'Away RC',
        'Home Avg Rating', 'Away Avg Rating',
        'Home Formation', 'Away Formation', 'Home XI Overall', 'Away XI Overall'
      ]);

      allMatches.forEach(match => {
        const home = match.report?.home;
        const away = match.report?.away;
        const formations = match.formations;

        if (!home || !away) return;

        const homeStats = aggregateTeamStats(home.playersStats);
        const awayStats = aggregateTeamStats(away.playersStats);

        if (!homeStats || !awayStats) return;

        const homePassAcc = homeStats.passes > 0 ? ((homeStats.passesAccurate / homeStats.passes) * 100).toFixed(1) : '0';
        const awayPassAcc = awayStats.passes > 0 ? ((awayStats.passesAccurate / awayStats.passes) * 100).toFixed(1) : '0';
        const homeShotAcc = homeStats.shots > 0 ? ((homeStats.shotsOnTarget / homeStats.shots) * 100).toFixed(1) : '0';
        const awayShotAcc = awayStats.shots > 0 ? ((awayStats.shotsOnTarget / awayStats.shots) * 100).toFixed(1) : '0';

        const homePasses = home.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
        const awayPasses = away.playersStats?.reduce((sum, p) => sum + (p.passes || 0), 0) || 0;
        const totalPasses = homePasses + awayPasses;
        const homePossession = totalPasses > 0 ? ((homePasses / totalPasses) * 100).toFixed(1) : '50.0';
        const awayPossession = totalPasses > 0 ? ((awayPasses / totalPasses) * 100).toFixed(1) : '50.0';

        const homeDefDuelWinRate = (homeStats.defensiveDuelsWon + homeStats.dribbledPast) > 0 
          ? ((homeStats.defensiveDuelsWon / (homeStats.defensiveDuelsWon + homeStats.dribbledPast)) * 100).toFixed(1) 
          : '0';
        const awayDefDuelWinRate = (awayStats.defensiveDuelsWon + awayStats.dribbledPast) > 0 
          ? ((awayStats.defensiveDuelsWon / (awayStats.defensiveDuelsWon + awayStats.dribbledPast)) * 100).toFixed(1) 
          : '0';

        const homeTotalDuels = homeStats.defensiveDuelsWon + homeStats.dribbledPast;
        const awayTotalDuels = awayStats.defensiveDuelsWon + awayStats.dribbledPast;

        let homeFormationType = '-';
        let awayFormationType = '-';
        let homeXIOverall = 0;
        let awayXIOverall = 0;
        let homeName = 'Home Team';
        let awayName = 'Away Team';

        if (formations) {
          const playerMap = extractPlayerMapFromFormations(formations);
          const clubNames = extractClubNames(formations);

          homeName = clubNames.homeName;
          awayName = clubNames.awayName;

          if (formations.homeFormation) {
            homeFormationType = formations.homeFormation.type || '-';
            homeXIOverall = computeXIOverall(formations.homeFormation, playerMap);
          }

          if (formations.awayFormation) {
            awayFormationType = formations.awayFormation.type || '-';
            awayXIOverall = computeXIOverall(formations.awayFormation, playerMap);
          }
        }

        rows.push([
          match.matchId,
          new Date(match.date).toISOString(),
          homeName,
          awayName,
          `${homeStats.goals}-${awayStats.goals}`,
          homeStats.goals,
          awayStats.goals,
          homeStats.xG.toFixed(2),
          awayStats.xG.toFixed(2),
          homeStats.shots,
          awayStats.shots,
          homeStats.shotsOnTarget,
          awayStats.shotsOnTarget,
          homeShotAcc,
          awayShotAcc,
          homePossession,
          awayPossession,
          homeStats.passes,
          awayStats.passes,
          homePassAcc,
          awayPassAcc,
          homeDefDuelWinRate,
          awayDefDuelWinRate,
          homeTotalDuels,
          awayTotalDuels,
          homeStats.shotsBlocked,
          awayStats.shotsBlocked,
          homeStats.ownGoals,
          awayStats.ownGoals,
          homeStats.fouls,
          awayStats.fouls,
          homeStats.yellowCards,
          awayStats.yellowCards,
          homeStats.redCards,
          awayStats.redCards,
          homeStats.avgRating,
          awayStats.avgRating,
          homeFormationType,
          awayFormationType,
          homeXIOverall,
          awayXIOverall
        ]);
      });

      const csv = rows.map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `friendly_matches_club${clubId}_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('load-btn').addEventListener('click', loadMatches);
    document.getElementById('add-match-btn').addEventListener('click', addMatch);
    document.getElementById('download-csv-btn').addEventListener('click', downloadCSV);

    document.getElementById('club-id').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadMatches();
    });

    document.getElementById('game-limit').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadMatches();
    });

    document.getElementById('match-id-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addMatch();
    });

    document.querySelectorAll('#player-detail-table th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.getAttribute('data-col');
        if (playerDetailSort.column === col) {
          playerDetailSort.asc = !playerDetailSort.asc;
        } else {
          playerDetailSort.column = col;
          playerDetailSort.asc = false;
        }
        renderPlayerDetail();
      });
    });
  </script>
</body>
</html>
